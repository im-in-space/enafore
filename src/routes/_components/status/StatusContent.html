<div class="status-content-wrapper">
  <div class={computedClass} ref:node>
    {@html massagedContent}
  </div>
  {#if showTranslate}
    <div class="status-translate-toolbar">
      <div class="status-translate-toolbar-label">
        {#if translating}
          Translating...
        {:else}
          {#if translateError}
            There was an error translating this post
          {:else}
            Translated post from {translatedFrom}
          {/if}
        {/if}
      </div>
      <IconButton
        label="Hide tranlation"
        href="#fa-times"
        on:click="onHideTranslateClick()"
      />
    </div>
  {/if}
</div>
<style>
  .status-content {
    padding: 10px 10px 10px 5px;
    word-wrap: break-word;
    overflow: hidden;
    white-space: pre-wrap;
    font-size: 1.17em;
    line-height: 1.369;
    display: none;
  }

  .status-content-wrapper {
    grid-area: content;
    width: 100%;
  }

  .status-content.status-in-own-thread {
    font-size: 1.69em;
    padding: 20px 10px 20px 5px;
  }

  .status-content.shown {
    display: block;
  }

  .status-translate-toolbar {
    font-size: 1.17em;
    margin: 10px 10px 10px 5px;
    border-radius: 3px;
    padding: 0.25rem 1rem;
    padding-right: 1rem;
    background: var(--toast-bg);
    color: var(--toast-text);
    border: 1px solid var(--toast-border);
    display: flex;
    align-items: center;
    padding-right: 0;
  }

  .status-translate-toolbar-label {
    flex-grow: 1;
    word-wrap: break-word;
    width: 0;
  }

  :global(
      .status-content p,
      .status-content blockquote,
      .status-content ul,
      .status-content ol) {
    margin: 0 0 20px;
  }

  :global(
      .status-content p:first-child,
      .status-content blockquote:first-child,
      .status-content ul:first-child,
      .status-content ol:first-child) {
    margin: 0 0 20px;
  }

  :global(
      .status-content p:last-child,
      .status-content blockquote:last-child,
      .status-content ul:last-child,
      .status-content ol:last-child) {
    margin: 0;
  }

  :global(.status-content blockquote) {
    padding-left: 1.5rem;
    border-left: 5px solid var(--body-bg);
    /*color: var(--very-deemphasized-text-color);
    font-style: italic;*/
  }

  :global(.status-content ul, .status-content ol) {
    padding-left: 2rem;
  }

  .status-content.status-in-notification {
    color: var(--very-deemphasized-text-color);
    --button-text: var(--very-deemphasized-text-color);
  }
  :global(.status-content.status-in-notification a, .status-mentions.status-in-notification a) {
    color: var(--very-deemphasized-link-color);
  }

  :global(.underline-links .status-content a) {
    text-decoration: underline;
  }

  @media (max-width: 240px) {
    :global(
      .status-content p:last-child,
      .status-content blockquote:last-child,
      .status-content ul:last-child,
      .status-content ol:last-child) {
      margin: 0 0 10px; /* looks better on KaiOS with some spacing here */
    }
  }

</style>
<script>
  import { store } from '../../_store/store.js'
  import { classname } from '../../_utils/classname.js'
  import { katexify } from '../../_utils/katexify.js'
  import IconButton from '../IconButton.html'

  export default {
    components: {
      IconButton
    },
    onupdate ({ changed }) {
      if (changed.massagedContent || changed.translateState) {
        if (this.refs.node) this.katexify()
        this.fire('recalculateHeight')
      }
    },
    store: () => store,
    computed: {
      computedClass: ({ isStatusInOwnThread, isStatusInNotification, shown, translating }) => {
        return classname(
          'status-content',
          isStatusInOwnThread && 'status-in-own-thread',
          isStatusInNotification && 'status-in-notification',
          shown && 'shown',
          translating && 'translating'
        )
      },
      content: ({ originalStatus }) => (originalStatus.content || ''),
      mentions: ({ originalStatus }) => originalStatus.mentions,
      massagedContent: ({ content, translateContent, showTranslate }) =>
        (showTranslate && translateContent)
          ? translateContent
          : content,
      computedTranslateClass: ({ isStatusInOwnThread, isStatusInNotification, shown }) => {
        return classname(
          'status-translate',
          isStatusInOwnThread && 'status-in-own-thread',
          isStatusInNotification && 'status-in-notification',
          shown && 'shown'
        )
      },
      translateKey: ({ $currentInstance, originalStatusId }) => $currentInstance + '-' + originalStatusId,
      translateState: ({ translateKey, $statusTranslations }) => {
        if (!$statusTranslations || !$statusTranslations[translateKey]) return null
        return $statusTranslations[translateKey]
      },
      showTranslate: ({ translateState }) => !!(translateState && translateState.show),
      translating: ({ translateState }) => !!(translateState && translateState.loading),
      translateError: ({ translateState }) => !!(translateState && translateState.error),
      translateContent_: ({ $statusTranslationContents, translateKey }) => {
        const tc = $statusTranslationContents[translateKey]
        if (!tc) return {}
        if (typeof tc === 'string') return { html: tc, detected: 'unknown' }
        return tc
      },
      translateContent: ({ translateContent_ }) => translateContent_.html,
      translatedFrom: ({ translateContent_, translateState }) => translateState && translateState.languageNames && (translateState.languageNames[translateContent_.detected] ? translateState.languageNames[translateContent_.detected] + ' (Detected)' : (translateState.languageNames[translateContent_.from] || translateContent_.detected))
    },
    methods: {
      katexify () {
        const renderPromise = katexify(this.refs.node)
        if (renderPromise) {
          renderPromise.then(() => {
            this.fire('recalculateHeight')
          })
        }
      },
      onHideTranslateClick () {
        let { translateKey, translateState } = this.get()
        translateState = translateState || {}
        const { statusTranslations, statusTranslationContents } = this.store.get()
        translateState.show = false
        statusTranslations[translateKey] = translateState
        delete statusTranslationContents[translateKey]
        this.store.set({ statusTranslations, statusTranslationContents })
      }
    }
  }
</script>
